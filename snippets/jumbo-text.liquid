{% liquid
  assign shown_text = text | default: block.settings.text
  unless block.settings.case == 'uppercase'
    if shown_text contains 'g' or shown_text contains 'j' or shown_text contains 'p' or shown_text contains 'q' or shown_text contains 'y'
    endif
  endunless
  assign shown_text_with_line_breaks = shown_text | newline_to_br
  assign text_with_lines = shown_text_with_line_breaks | split: '<br />'
%}

{% capture attributes %}
  {{ block.shopify_attributes }}
{% endcapture %}

<div class="jumbo-text__container w-full">
  {% if text != blank %}
    <jumbo-text
      class="{% if block.settings.uppercase %}uppercase {% endif %}block w-full"
      {{ attributes }}
    >
      {{- text -}}
    </jumbo-text>
  {% else %}
    <jumbo-text
      class="{% if block.settings.uppercase %}uppercase {% endif %}block w-full"
      {{ attributes }}
      aria-label="{{ shown_text }}"
    >
      {%- assign char_index = 0 -%}
      {%- for line in text_with_lines -%}
        {%- if forloop.index > 1 -%}
          <br>
        {%- endif -%}
        <span
          class="jumbo-text-line"
          style="--line-index: {{ forloop.index }};"
          data-testid="jumbo-text-line"
        >
          {%- assign chars = line | split: ' ' | join: ' ' | split: '' -%}
          {%- for char in chars -%}
            {%- if char == ' ' -%}
              <span
                class="jumbo-text-space"
                aria-hidden="true"
              >
                {{ char }}
              </span>
            {%- else -%}
              <span
                class="jumbo-text-char"
                style="--char-index: {{ char_index }};"
                aria-hidden="true"
              >
                <span class="jumbo-text-char-inner">{{ char }}</span>
              </span>
              {%- assign char_index = char_index | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}
        </span>
      {%- endfor -%}
    </jumbo-text>
  {% endif %}
</div>

<script
  src="{{ 'jumbo-text.js' | asset_url }}"
  type="module"
></script>

<script>
  if (window.Shopify && Shopify.designMode) {
    document.addEventListener('shopify:section:select', function (e) {
      const block = e.target.closest('[data-block-id]');
      if (!block) return;
      const textArea = block.querySelector('textarea[name$="[text]"]');
      const jumbo = block.querySelector('jumbo-text');
      if (textArea && jumbo) {
        textArea.addEventListener('input', function () {
          jumbo.innerHTML = textArea.value;
          if (typeof jumbo.#calculateOptimalFontSize === 'function') {
            jumbo.#calculateOptimalFontSize();
          }
        });
      }
    });
  }
</script>

{% stylesheet %}
  .jumbo-text-space {
    display: inline-flex;
    width: 0.5ch;
  }

  :is(.jumbo-text-char, .jumbo-text-line) {
    display: inline-flex;
  }
{% endstylesheet %}
